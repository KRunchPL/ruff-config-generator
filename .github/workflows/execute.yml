name: Check for newer ruff version

on:
  # schedule:
  #   - cron: '0 5 * * *'  # 5:00 AM UTC daily
  workflow_dispatch:

jobs:
  check_for_new_ruff_version:
    name: Check for newer ruff version
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.13"]
        uv-version: ["0.6.10"]
        os: ["ubuntu-latest"]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      pull-requests: write
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        persist-credentials: true
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: ${{ matrix.uv-version }}
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install package with dependencies
      run: uv sync
    - name: Regenerate
      run: |
        uv run python -m ruff_config_generator
        git add workdir
        git diff-index --quiet HEAD -- || (echo "New ruff version found"; exit 1)
        if [ $? -eq 0 ]; then
          echo "No new ruff version found."
          exit 0
        else
          echo "New ruff version found."
          exit 1
        fi
    - name: Push and create PR
      if: ${{ failure() }}
      run: |
        git diff-index HEAD --
        git diff
        new_version=$(<workdir/version.txt)
        branch_name="ruff-$new_version"
        pr_body="Configuration generated for ruff $new_version.\n\nThis pull request was created automatically by a GitHub Action."

        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        git checkout -b $branch_name
        git add workdir
        git commit -m "ruff $new_version"
        git push origin $branch_name

        curl -L
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          --url https://api.github.com/repos/${{ github.repository }}/pulls \
          -d '{"title": "Ruff $new_version","body": "$pr_body","head": "$branch_name","base": "master"}' \
          --fail
